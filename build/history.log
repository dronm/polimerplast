1.0089 - 91 26/08/18
1) Группа аналитического учета в продукции
2) Запрет изменения вида оплаты, если уже уже выписан ПКО
3) Разные кассы нал и терминал: галочка в справочнике "кассы" в 1с. Т.е. там где оплата по карте надо поставить галочку
4) Справочник Автомобили: водитель первым, сортировка по нему
5) Заявка: при изменении счета создается новый счет
6) Счет в 1с: комментарий как в РНК
7) При изменении адреса, при вводе нового адреса: пересчет стоимости доставки

1.0100 04/12/18


1.0103 19/01/19
1) Поле Грузополучатель в заявке

1.0104 20/01/19
Физическое лицо в 1с из водителя, тест
Исправлена обязательность реквизита Грузополучатель

1.0105 30/01/19
1) Поиск банков по БИК, обновление банков
2) Поиск контрагентов по ИНН
3) Синхронизация с 1с: создание нового в 1с, если нет такого по инн

1.0106 01/02/19
1) Грузополучатель исправлена обязательность при записи

1.0107 26/02/19
1) поле Автомобиль,адрес в ТТН в заявке, выведено в отгрузку
	doc_orders_shipment_dialog
	DOCOrder->set_shipped()
	DOCOrderShipmentDialog doc_orders_shipment_dialog
1.0102 26/02/19	
Исправлены ошибки	


1.0108
Есть еще такая проблема при копировании и редактировании заявок все данные по доставкам изменяются после записи.
Например если скопировать заявку с доставкой  и сделать самовывоз итоговая сумма будет неверная, после
записи все исправиться, но в стадии создания сумма доставки есть, а после записи исчезает.
ИСПРАВИЛ

Добавление менеджера к новой организации
Точно знаю, что это я проверял, но проверил еще раз: создал нового контрагента, которого ни в 1с, ни в црм не было.
Менеджером поставилась Володина, т.к. именно она привязана к моей учетной записи в црм. В 1с поле "Основной менеджер",
может я не то смотрю, и это какое-то другое поле? Смотри мое вложение

Потратил 30 минут
выбор региона при редактировании адреса

1.0109 13/05
1) Выбо договора в заявке, перенос в Счет/Накладную


1.0112 17/05
1) Доступ к договору при копировании
2) Добавление машин в доставке, сказалось исправление ButtonSelectObject->onBeforeSelect, теперь исправил DelivAssignedOrderGridCommands.prototype.addInsert


1.0113 21/05
1) Договор доступен при записанной, статус ожидание оплаты
2) Печать DOCOrder.html.xsl нашлепка с адресом убрал absolute позицию при печати >6 строк
3)product_measure_units_check при единице ид=6 пересчет по-другому чкрез функцию doc_order_calc_quant_in_mu
doc_order_totals при единице ид=6 пересчет по-другому чкрез функцию doc_order_calc_quant_in_mu
4) doc_order_calc_quant_in_mu автономна без doc_order_calc_quant

1.0114 24/05
1) Договор всегда открыт для изменения пока не отгрузят
2) Отгрузка без изменения кол-ва авто, без доставки в 1с поменял doc_orders_set_shipped
3) Пересчет итогов заявки при установке нового расстояния
4) Пересчет из м2 отдельно от печ.фрм, другая функция ноавя функция doc_order_calc_quant_in_mu_for_totals вызывается из doc_order_totals


1.0115 24/05
1) esc в адресе
2) Поиск по БИК
3) Зацикливание в заявке при окончании редактирования продукции при нажатой "распределять пропорциональнодоставку"


1.0116 26/05
Зацикливание

1.0117 06/06
1) ClientDestination_Controller косяк при записи адреса region
2) DOCOrderDOCTProduct_Controller insert/update пересчет м2 чеерез целые при вводе в м2
3)При записи на сервере, если Доставка=Поставщик,Есть категория авто, но затраты по доставке=0, то затраты по доставке
все равно рассчитать исходя из категории авто
Переделал через ГУИ: теперь еще и пишется что ставка по городу

1.0118 07/06
1) При копировании заявки, если самовывоз бывает что количество авто=NULL, в гуи надо ставить 0 DOCOrderDialog_View.js->onGetData


1.0119 11/06
1) При поиске контрагента по ЕГРЮЛ краткое наименование


1.0120 12/07
1) Категория резки в отчете
2) Добавить галочку "Включать стоимость доставки пропорционально..." контрагенту. Перенос галочки в заявку при создании

- При создании нового контрагента в CRM,если его нет, а в 1с есть - ошибка какая-то, надо просто писать и все


1.0121 24/07
1) Смена типа доставки не пересчитывает цены: самовывоз <-> поставщик, только итоги - ИСПРАВИЛ DelivTypeEditObject->onChange вызов recalcPricesRefreshTotals
2) Скрипт на сервере при выписке накладной если нет:
	Номера договора - берем номер документа,
	Даты договора - берем дату документа

1.0122
1) Косяки при смене объема: не считает авто


1.0123 04/09/19
1) doc_order_totals() добавлен параметр total, если не 0 и edit_price=TRUE, то значение сумму не менеяется ни при каких пересчетах!
doc_order_totals_all()
DOCOrderDOCTProduct_Controller insert/update откорректированы на новый вызов doc_order_totals
DOCOrder_Controller recalc_product_prices()


При отгрузке меньшего количества чем в заявке, во вновь созданной заявке цена фиксируется (отмечена как будто вручную)
doc_orders_set_shipped.sql INSERT INTO doc_orders_t_products всегда TRUE


1.0127 16/09/19
Слив изменений в рабочую базу
1) Пересчет как в тесте
2) Открытие документа из нераспределенных доставок - как в тесте
3) Виды деятельности можно новые заводить и привязывать
4) Эл.почта попадает из 1с при поиске по названию
5) Галочка "Поставщик" в клиентах. Клиент как и было встает всегда, "поставщик" можно ставить дополнительно


1.0128 19/09/19
1) Галочка перевозчик, перенос в 1с
2) Кредиторская задолженность из 1с
3) Информация по долгам в заявке крупнее
4) Яндекс Геокодирование

1.0129 03/10/19
1) Прикопировании продукции цены заявки цена изменялась при редактировании количества
2) Копирование телефонов


1.0130 поставил в тест
1) Подтянуть галочки Поставщик, перевозчие при создании нового контрагента

- Кнопка "Уведомить кладовщика"
- Пересчитать все накладные где не заполнена сумма т/р
- Пересчитать где null в сумме
- Галочка поставщик/перевозчик перетащили из 1с, записали - в 1с все пропало



1.0132 29/01/20 поставил в тест
1) Справочник банковских счетов наших фирм для клиентов
2) Не открывался список контрагентов из заявки


1.0133 31/01/20 поставил в тест
1) recalc_product_prices не было сортировки по номуру строки!!!
2) При открытии документа, сохраненного с доставкой в т.ч. показывает строки без учета доставки
3) При удалении строки нужен пересчет recalc_product_prices


DocOrderDOCTProductDialog_View
doc_orders_t_tmp_products_process()
price_no_deliv
total_no_deliv


1.0134 02/03/20
все изменения поставил в Рабочую базу

Косяки в ценах
update doc_orders_t_products
set
total_no_deliv=coalesce(total,0)-coalesce(total_deliv,0)
,price_no_deliv= (  coalesce(total,0)-coalesce(total_deliv,0) ) / quant_base_measure_unit
where 
coalesce(total_no_deliv,0)=0 and coalesce(price_no_deliv,0)=0 and coalesce(total,0)>0


1.0135 28/04/20
1) Косяк при удалении строки из заявки - счет не меняется! не записывается изменение в историю из-за неправильного запроса определения
изменений в DOCOrderModel->update()
Добавлен юнион запрос


1.0135 17/02/21
+1) Переносить стоимость доставки в новое поле в 1с
+2) Константы для значерий по-умолчанию: 
Включать стоимость доставки пропорционально в стоимость продукции order_deliv_add_cost_to_product
Переносить адрес доставки в ТТН destination_to_ttn
+Печатать пустого перевозчика
также deliv_add_cost_to_product есть в моделях клиента, там изменены значения по умолчанию на константу
	ClientComplete

3) Вытащить настройку перевозчиков справочника Перевозчики
4) писок констант для редактирования
SESSION['order_destination_to_ttn']
ViewBase.php
User_Controller.php
5) Справочник фирм поле order_deliv_add_cost_to_product, doc_orders_data_for_ext зафисит от firms.order_deliv_add_cost_to_product

1.0136

1.0137
1) Product1cName_Controller + справочник, форма и т.д.
2) Файлы вложений для DOCOrder

1.0139
1) doc_orders_dialog_no_att.sql - форма диалога без вложений, doc_orders_print_h.sql вызвает doc_orders_dialog_no_att
views/DOCOrder.html.xsl + Самовывоз
2) DOCOrderDialog_View.js печать вложений, DOCOrder_Controller.php  новый метод



//**************
1)
Замены для php8
ModelSQLDOCT20,
public function insert($needId=FALSE,$row=NULL){
ModelSQLDOCPl
public function insert($needId=FALSE,$row=NULL){
	public function select($insertMode=FALSE,
					$modelWhere=NULL,
					$modelOrder=NULL,
					$modelLimit=NULL,
					$fieldArray=NULL,
					$grpFieldArray=NULL,
					$aggFieldArray=NULL,
					$calcTotalCount=NULL,
					$toXML=NULL,
					$copyMode=FALSE){
models/DOCOrder_Model::insert(
public function insert($needId = FALSE, $row = NULL){

common/OSRMV5
error_log(self::ER_BAD_RESPONSE.' URL='.$url);


1.0140 27/03/23
Исправил косяк controls/actb.js коммент от 03/03/23



1.0141 20/07/23
1) doc_orders_set_shipped.sql изменен комментарий новой заявки
2) Возможность включения в отчет неотгруженных заявок: RepSales_View.js, Report_Controller_php.xsl



27/02/24
Локальная база polimerplast = копия рабочей на 27/02/24
Задача: при разделении заявки на остаток формируется новая заявка,
также формируется новый счет (не понятно в какой момент, говорят, что при передаче в производство)
Необходимо убрать формирование счета.
models/DOCOrder_Model->update() added variable $derived_from_split_order

controllers/DOCOrder->docDataForExt()


07/03/24
+SaleStoreAddress - справочник
DOCOrder_Controller добавлено два поля: sale_store_id, order_num, 
DOCOrderDialog_View.js
EditObjects.js
SaleStoreAddressList_View.js
SaleStoreAddressInline_View.js
doc_orders_data_for_ext.sql added fields 
		order_num,sale_store_address_code
DOCOrder_Controller->docDataForExt() 2 new fields added. 
!!! Проверить на тестовой базе с локалки, в паре с 1с с тестового сервера.!!!



27/03/24
+ new_field batch_num
DOCOrderShipmentDialog_View.js
DOCOrder_Controller
	set_shipped()
	docDataForExt()
doc_orders_data_for_ext.sql +new field
doc_orders_set_shipped.sql +new field
doc_orders_shipment_dialog.sql

08/04/24
DOCOrderShipmentDialog_View.js batch_num is a Text, not number!


1.0146
1) New table, controller: DocOrderProdBatch_Controller 
	Вызов метода на стороне 1с DocOrderBatchController->get_1c_list()
	Выбор в ГУИ партии при отгрузке
	Передача партий в накладную при отгрузке
	doc_orders_before_open.sql, doc_orders_before_write.sql
	DOCOrderDOCTProdBatch_Controller_php.xsl
	doc_orders_data_for_ext.sql added field to hold prod_batches
	doc_orders_process.sql delete new detail table data.
	DOCOrder_Controller->docDataForExt() new field

2) Views/DocOrderCheck.html.xsl Значение графы "Отпустил" для одной конторы.
3) GridDbDOCT some functions are copied and corrected from parent class to handle inline edit insert case.



1.0147
1) DOCOrderDOCTProduct, DOCOrderDOCTFProduct new column price_round bool
	doc_orders_t_tmp_products, doc_orders_t_products
	DOCOrder_Controller->calc_totals() new parameter price_round
	doc_order_totals2() added parameter price_round
	DOCOrder_Controller->calc_totals() changed call to sql function doc_order_totals()
	DOCOrderDOCTProduct->update() call to function doc_order_totals()
	DocOrderDOCTProductDialog_View  added this.m_priceRoundCtrl
		this call to calc_totals() server method.

doc_orders_t_tmp_prod_batches_list
	V doc_orders_t_tmp_products_dialog.sql
	V doc_orders_t_products_dialog.sql
	V doc_orders_t_tmp_prod_batches_list
	V doc_orders_t_tmp_prod_batches.sql
	V doc_orders_t_tmp_prod_batches_process
	V doc_orders_before_write.sql
	V doc_orders_before_open.sql
	V doc_orders_set_shipped.sql



//То, что мешает жить:
- Если чсета нет, а нажали "Счет" выходит ошибка в новом окно - счет не выписан
- Создание файлов GUID.zip при создании счета. Это не удаляется. Тупой механизм при создании счета, потом скачивание,
	временное хранение.
+ Обработка ошибок в модальном окне.	
- Запрос
	select * from doc_orders_list  order by date_time desc limit 50
		выполняется 6с, если без сортировки, то менее 1с
		Если не через VIEW, на прямую зарос - также быстро







!!!
ПРИ СОЗДАНИИ КОНТРОЛЛЕРА!!!
исправить в шаблоне <xsl:import href="Controller_js.xsl"/>
